{% extends '../core/base.html' %}
{% load static %}

{% block title %}{{ seo.title }}{% endblock title %}
{% block seodescription %}{{ seo.description }}{% endblock seodescription %}
{% block seoimage %}{{ seo.image }}{% endblock seoimage %}

{% block content %}
    <img src="{{ page_config.logo.url }}" alt="Logo" style="max-height: 100px;">
    <h1>{{ page_config.page_name }}</h1>
    <p>Last Update: {{ page_config.last_update }}</p>
    
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>نام محصول</th>
                <th>تعداد</th>
                <th>قیمت واحد</th>
                <th>درصد تخفیف</th>
                <th>قیمت کل</th>
            </tr>
        </thead>
        <tbody>
            {% for page_product in page_config.page_config_products.all %}
                <tr data-product-id="{{ page_product.product.id }}" data-price="{{ page_product.product.price }}" data-offer-price="{{ page_product.product.offer_price }}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ page_product.product.title }}</td>
                    <td class="quantity">{{ page_product.quantity }}</td>
                    <td class="product-price">{{ page_product.product.price }} تومان</td>
                    <td class="discount-percentage">---</td>
                    <td class="total-price">---</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- PDF Button -->
    <div class="text-end">
        <a href="{% url 'product:generate_pdf' slug=page_config.slug %}" class="btn btn-primary">Download PDF</a>
    </div>

    <script type="text/javascript">
        // تابعی برای محاسبه درصد تخفیف و قیمت کل
        function calculateDiscountAndTotal() {
            // پیدا کردن تمام ردیف‌های جدول
            const rows = document.querySelectorAll('table tbody tr');
            console.log('rows: ', rows);

            rows.forEach(row => {
                const priceElement = row.querySelector('.product-price');
                const discountElement = row.querySelector('.discount-percentage');
                const totalElement = row.querySelector('.total-price');
                
                // استخراج قیمت و تخفیف از دیتابیس
                const price = parseFloat(row.getAttribute('data-price'));
                const offerPrice = parseFloat(row.getAttribute('data-offer-price'));
                const quantity = parseInt(row.querySelector('.quantity').textContent);
                // چاپ قیمت کل در کنسول برای خطایابی
                console.log('quantity: ', quantity);
                if (offerPrice > 0) {
                    // محاسبه درصد تخفیف
                    const discountPercentage = ((price - offerPrice) / price) * 100;

                    // محاسبه قیمت کل با فرمول جدید
                    const totalPrice = price * (1 - discountPercentage / 100) * quantity;

                    // نمایش درصد تخفیف و قیمت کل
                    discountElement.textContent = discountPercentage.toFixed(0) + '%';
                    totalElement.textContent = totalPrice.toFixed(0) + ' تومان';


                } else {
                    discountElement.textContent = 'تخفیف ندارد';
                    totalElement.textContent = (price * quantity).toFixed(0) + ' تومان';

                }
            });
        }

        // زمانی که صفحه بارگذاری شد، محاسبات را انجام بده
        document.addEventListener('DOMContentLoaded', function() {
            calculateDiscountAndTotal();
        });
    </script>
{% endblock content %}
