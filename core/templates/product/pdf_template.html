{% load static %}

<!DOCTYPE html>
<html lang="fa" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>{{ page_name }}</title>
        <style>
            @font-face {
                font-family: 'iransans';
                src: url('static/fonts/IRANSans/IRANSansWeb.ttf');
            }

            /* استایل هدر */
            .header {
                text-align: center;
                padding: 10px;
                background-color: #f2f2f2;
                border-bottom: 2px solid #000;
            }

            .header img {
                max-height: 50px;
            }

            /* استایل جدول */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            table, th, td {
                border: 1px solid black;
            }
            th, td {
                padding: 8px;
                text-align: right;
            }
        </style>
        
    </head>
    <body>

        <div class="header">
            <h1>{{ page_name }}</h1>
            <p>تاریخ: {{ last_update }}</p>
            {% if logo %}
                <img src="{{ logo.url }}" alt="Logo">
            {% endif %}
        </div>

        <table>
            <tbody>
                <tr>
                    <td rowspan="3">فروشنده</td>
                    <td>پی خاک سنگ</td>
                    <td><img src="{{ logo.url }}" alt="Logo" style="max-height: 100px;"></td>
                </tr>
                <tr>
                    <td colspan="2">نشانی : تهران - خیابان پیروزی - بلوار ابوذر شمالی - کوچه ششم شرقی - پلاک 9</td>
                </tr>
                <tr>    
                    <td colspan="2">تلفن: 021_33163222 _ 33076061</td>
                </tr>
                <tr>
                    <td rowspan="3">خریدار</td>
                    <td colspan="2">آقای/خانم/شرکت:</td>
                </tr>
                <tr>
                    <td colspan="2">نشانی:</td>
                </tr>
                <tr>
                    <td colspan="2">تلفن:</td>
                </tr>
            </tbody>
        </table>

        <!-- Products Table -->
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>نام محصول</th>
                    <th>تعداد</th>
                    <th>قیمت واحد</th>
                    <th>درصد تخفیف</th>
                    <th>قیمت کل</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                    <tr data-product-id="{{ product.product.id }}" 
                        data-price="{{ product.product.price }}" 
                        data-offer-price="{{ product.product.offer_price }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ product.product.title }}</td>
                        <td class="quantity">{{ product.quantity }}</td>
                        <td class="product-price">{{ product.product.price }} تومان</td>
                        <td class="discount-percentage">---</td>
                        <td class="total-price">---</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Footer Section -->
        <div class="footer">
            <p>Thank you for choosing us!</p>
        </div>
    </div>
    <script type="text/javascript">
        // تابعی برای محاسبه درصد تخفیف و قیمت کل
        function calculateDiscountAndTotal() {
            // پیدا کردن تمام ردیف‌های جدول
            const rows = document.querySelectorAll('table tbody tr');
            console.log('rows: ', rows);

            rows.forEach(row => {
                const priceElement = row.querySelector('.product-price');
                const discountElement = row.querySelector('.discount-percentage');
                const totalElement = row.querySelector('.total-price');
                
                // استخراج قیمت و تخفیف از دیتابیس
                const price = parseFloat(row.getAttribute('data-price'));
                const offerPrice = parseFloat(row.getAttribute('data-offer-price'));
                const quantity = parseInt(row.querySelector('.quantity').textContent);
                // اگر قیمت تخفیف خورده وجود داشته باشد
                if (offerPrice > 0) {
                    // محاسبه درصد تخفیف
                    const discountPercentage = ((price - offerPrice) / price) * 100;

                    // محاسبه قیمت کل با فرمول جدید
                    const totalPrice = price * (1 - discountPercentage / 100) * quantity;

                    // نمایش درصد تخفیف و قیمت کل
                    discountElement.textContent = discountPercentage.toFixed(0) + '%';
                    totalElement.textContent = totalPrice.toFixed(0) + ' تومان';
                } else {
                    // اگر تخفیف نداشتیم
                    discountElement.textContent = 'تخفیف ندارد';
                    totalElement.textContent = (price * quantity).toFixed(0) + ' تومان';
                }
            });
        }

        // زمانی که صفحه بارگذاری شد، محاسبات را انجام بده
        document.addEventListener('DOMContentLoaded', function() {
            calculateDiscountAndTotal();
        });
    </script>
</body>
</html>



